services:
  fl-server:
    image: fl-app-image:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: fl_server
    volumes:
      - ../src:/app
    networks:
      - fl-network

  client-full:
    image: fl-app-image:latest  # <--- Reusa a mesma imagem!
    depends_on:
      - fl-server
    volumes:
      - ../src:/app
    environment:
      - MODE=client
      - SERVER_URL=http://fl-server:5000
      - HOSTNAME=client-full
    networks:
      - fl-network

  client-noisy:
    image: fl-app-image:latest  # <--- Reusa a mesma imagem!
    container_name: cliente_instavel
    depends_on:
      - fl-server
    volumes:
      - ../src:/app
    environment:
      - MODE=client
      - SERVER_URL=http://fl-server:5000
      - HOSTNAME=client-noisy
    networks:
      - fl-network

  dashboard:
    image: fl-app-image:latest
    command: streamlit run dashboard.py --server.port 8501
    ports:
      - "8501:8501"
    volumes:
      - ../src:/app
    networks:
      - fl-network

  # --- O SUBSTITUTO DO PUMBA ---
  chaos-injector:
    image: alpine:latest
    container_name: chaos_injector
    # Instala o pacote de rede e aplica 20% de perda na interface eth0
    command: >
      sh -c "apk add --no-cache iproute2 &&
             echo 'Aplicando regras de caos...' &&
             tc qdisc add dev eth0 root netem loss 20% &&
             echo 'Caos ativado: 20% packet loss no cliente_instavel' &&
             sleep infinity"
    cap_add:
      - NET_ADMIN # Permiss√£o para modificar a rede
    # O Pulo do Gato: Usa a MESMA rede do cliente alvo
    network_mode: service:client-noisy
    depends_on:
      - client-noisy

networks:
  fl-network:
    driver: bridge